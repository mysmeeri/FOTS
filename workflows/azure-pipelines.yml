trigger:
  - '*'

parameters:
  - name: environment
    displayName: "Select env"
    type: string
    default: dev
    values:
      - dev
      - test
      - prod

  - name: deployInfra
    type: boolean
    default: false
    displayName: "Deploy infrastructure?"

  - name: DeployAPI
    type: boolean
    default: false
    displayName: "Deploy API to AppService?"

pool:
  name: Default

stages:
  - stage: Validate
    displayName: "Validate"
    jobs:
      - job: ValidateInfra
        displayName: "Placeholder for validation logic"
        steps:
          - checkout: self
          - script: echo "Validation would happen here if I had more time"
            displayName: "Skip validation (for now)"

  - stage: DeployRG
    displayName: "Deploy ResourceGroups to Azure"
    condition: eq('${{ parameters.deployInfra }}', 'true')
#    dependsOn: Validate
#    condition: succeeded()

    jobs:
      - job: DeployInfra
        steps:
          - checkout: self

          - task: AzurePowerShell@5
            displayName: "Check if RG exists if not Deploy"
            inputs:
              azureSubscription: "FOTS-infra-SC" # TO DO t채m채n voisi parametrisoida
              ScriptType: "InlineScript"
              Inline: |
                $env = '${{ parameters.environment }}'
                $jsonPath = "$(System.DefaultWorkingDirectory)/infra/variables/$env/resourceGroups.json"
                $rgs = Get-Content $jsonPath | ConvertFrom-Json

                foreach ($rg in $rgs) {
                  $rgName = $rg.name
                  $location = $rg.location

                  Write-Host "Processing RG '$rgName' in $location..."
                  $existing = Get-AzResourceGroup -Name $rgName -ErrorAction SilentlyContinue

                  if (-not $existing) {
                    New-AzResourceGroup -Name $rgName -Location $location -Tag @{ Creation = 'IaC' }
                    Write-Host "Created resource group: $rgName"
                  }
                  else {
                    Write-Host "Already exists: $rgName"
                  }
                }
              azurePowerShellVersion: "LatestVersion"

  - stage: DeployResources
    displayName: "Deploy resources into Resource Groups"
    condition: eq('${{ parameters.deployInfra }}', 'true')
 #   dependsOn: DeployRG
 #   condition: succeeded()

    jobs:
      - job: DeployToRGs
        displayName: "Deploy resources to all RGs"
        steps:
          - checkout: self

          
          - task: AzureCLI@2
            displayName: "Deploy Resources"
            inputs:
              azureSubscription: "FOTS-infra-SC" # TO DO t채m채n voisi parametrisoida
              scriptType: "ps"
              scriptLocation: "inlineScript"
              inlineScript: |
                $env = '${{ parameters.environment }}'

                $bicepPath = "$(System.DefaultWorkingDirectory)/infra/deployment/main-$env.bicep"
                $paramPath = "$(System.DefaultWorkingDirectory)/infra/variables/$env/resourceVariables.json"

                Write-Host "Deploying subscription-level template..."
                az deployment sub create `
                  --location westeurope `
                  --template-file $bicepPath `
                  --parameters @$paramPath


  - stage: BuildAPI
    displayName: "Build API"
    condition: eq('${{ parameters.deployApi }}', 'true')

    jobs:
      - job: BuildAPI
        displayName: "Build Phase"
        steps:
          - checkout: self

          
          - script: echo "Run tests here..."
            displayName: "Test placeholder"
          
          - script: echo "Run linting here... Whatever that means"
            displayName: "Lint placeholder"

          
          - task: ArchiveFiles@2
            displayName: "Package API into ZIP"
            inputs:
              rootFolderOrFile: "$(System.DefaultWorkingDirectory)/api/app"
              includeRootFolder: false
              archiveType: zip
              archiveFile: "$(Build.ArtifactStagingDirectory)/api.zip"
              replaceExistingArchive: true

          # this publishes the zip as an artifact so we can use it in the next phase
          - publish: "$(Build.ArtifactStagingDirectory)/api.zip"
            artifact: "api"

      - job: DeployAPI
        displayName: Deploy API to App Service
        dependsOn: BuildAPI
        variables:
         appServiceName: "FOTS-app-dev-as" #TO DO: PARAMETRISOI
        steps:
          - download: current
            artifact: "api" # look! here is the artifact
          - task: PowerShell@2
            displayName: "Load resource variables"
            inputs:
              targetType: inline
              script: |
                $env = '${{ parameters.environment }}'
                $jsonPath = "$(System.DefaultWorkingDirectory)/infra/variables/$env/resourceVariables.json"
                $data = Get-Content $jsonPath | ConvertFrom-Json

                Write-Host "##vso[task.setvariable variable=appServiceName]$($data.parameters.appService.value.name)"
                Write-Host "##vso[task.setvariable variable=appServiceRG]$($data.parameters.appService.value.resourceGroup)"

          - task: AzureCLI@2
            displayName: "Enable build during deployment"
            inputs:
              azureSubscription: "FOTS-infra-SC"
              scriptType: ps
              scriptLocation: inlineScript
              inlineScript: |
                $resourceGroupName = "$(appServiceRG)"
                $appServiceName = "$(appServiceName)"

                az webapp config appsettings set `
                  --resource-group $resourceGroupName `
                  --name $appServiceName `
                  --settings SCM_DO_BUILD_DURING_DEPLOYMENT=true

          
          - task: AzureWebApp@1
            displayName: "Deploy ZIP package"
            inputs:
              azureSubscription: "FOTS-infra-SC"
              appName: "$(appServiceName)"
              package: "$(Pipeline.Workspace)/api/api.zip"